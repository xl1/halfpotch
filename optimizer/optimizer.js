// Generated by CoffeeScript 1.12.6
(function() {
  var $, Assoc, CartSelectView, Color, ColorSelectView, DataLoader, DataProcessor, ELSE, FormView, IF, ItemStoreMatrix, Model, PartImageView, ProgressButton, ResultView, Retention, Router, Searcher, SelectModel, SelectView, Solver, StoreDataLoader, SuperArray, View, constants, escapeHTML, unescapeHTML, uuid, xhrget,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    slice = [].slice,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  $ = function(id) {
    return document.getElementById(id);
  };

  escapeHTML = (function() {
    var re, replacer;
    re = /[&<>'"]/g;
    replacer = function(x) {
      return '&#' + x.charCodeAt(0) + ';';
    };
    return function(text) {
      return text.replace(re, replacer);
    };
  })();

  unescapeHTML = (function() {
    var div;
    div = document.createElement('div');
    return function(text) {
      div.innerHTML = text;
      return div.textContent;
    };
  })();

  SuperArray = (function(superClass) {
    extend(SuperArray, superClass);

    function SuperArray(ary) {
      if (ary == null) {
        ary = [];
      }
      Array.prototype.push.apply(this, ary);
    }

    SuperArray.prototype.minBy = function(func) {
      var d, j, len1, min, ref, ref1, res, solution;
      min = 2e308;
      solution = null;
      ref = this;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        d = ref[j];
        res = func(d);
        if (min > res) {
          ref1 = [res, d], min = ref1[0], solution = ref1[1];
        }
      }
      return solution;
    };

    SuperArray.prototype.maxBy = function(func) {
      return this.minBy(function(d) {
        return -func(d);
      });
    };

    SuperArray.prototype.min = function() {
      return Math.min.apply(Math, this);
    };

    SuperArray.prototype.max = function() {
      return Math.max.apply(Math, this);
    };

    SuperArray.prototype.combinations = function(len) {
      var a, i, j, l, last, len1, len2, ref, ref1, res;
      if (!len) {
        return [[]];
      }
      res = [];
      ref = this;
      for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
        a = ref[i];
        ref1 = SuperArray.prototype.combinations.call(this.slice(i + 1), len - 1);
        for (l = 0, len2 = ref1.length; l < len2; l++) {
          last = ref1[l];
          res.push([a].concat(last));
        }
      }
      return res;
    };

    return SuperArray;

  })(Array);

  uuid = (function() {
    var re, replacer;
    re = /[xy]/g;
    replacer = function(c) {
      var r;
      r = Math.random() * 16 | 0;
      return (c === 'x' ? r : r & 3 | 8).toString(16);
    };
    return function() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(re, replacer).toUpperCase();
    };
  })();

  Model = (function() {
    function Model() {
      this._uuid = uuid();
    }

    Model.prototype.change = function() {
      var arg, name;
      name = arguments[0], arg = 2 <= arguments.length ? slice.call(arguments, 1) : [];
      if (name == null) {
        name = 'change';
      }
      return eve.apply(null, [this._uuid + "." + name, this].concat(slice.call(arg)));
    };

    Model.prototype.listen = function(name, func) {
      if (name == null) {
        name = 'change';
      }
      if (arguments.length === 1) {
        func = name;
        name = 'change';
      }
      return eve.on(this._uuid + "." + name, func);
    };

    Model.prototype.unlisten = function(name, func) {
      if (name == null) {
        name = 'change';
      }
      if (arguments.length === 1) {
        func = name;
        name = 'change';
      }
      return eve.off(this._uuid + "." + name, func);
    };

    return Model;

  })();

  View = (function() {
    function View(model) {
      this.setModel(model);
    }

    View.prototype.setModel = function(model) {
      if (this._listener) {
        model.unlisten(this._listener);
      }
      this.model = model;
      this._listener = (function(_this) {
        return function() {
          return _this.render.apply(_this, arguments);
        };
      })(this);
      model.listen(this._listener);
      return this;
    };

    View.prototype.render = function() {};

    return View;

  })();

  Color = (function() {
    function Color(r1, g1, b1) {
      this.r = r1 != null ? r1 : 0;
      this.g = g1 != null ? g1 : 0;
      this.b = b1 != null ? b1 : 0;
    }

    Color.prototype.dist = function(color) {
      var db, dg, dr, ref;
      ref = [color.r - this.r, color.g - this.g, color.b - this.b], dr = ref[0], dg = ref[1], db = ref[2];
      return Math.sqrt(dr * dr + dg * dg + db * db);
    };

    Color.prototype.luma = function() {
      return this.r * 0.3 + this.g * 0.59 + this.b * 0.11;
    };

    Color.prototype.toArray = function() {
      return [this.r, this.g, this.b];
    };

    Color.prototype.toString = function() {
      return "rgb(" + this.r + ", " + this.g + ", " + this.b + ")";
    };

    return Color;

  })();

  Assoc = (function(superClass) {
    extend(Assoc, superClass);

    function Assoc(map) {
      this.map = map != null ? map : {};
      Assoc.__super__.constructor.apply(this, arguments);
    }

    Assoc.prototype.keys = function() {
      return Object.keys(this.map);
    };

    Assoc.prototype.get = function(name) {
      return this.map[name];
    };

    Assoc.prototype.set = function(name, value) {
      this.map[name] = value;
      return this.change('change', name, value);
    };

    return Assoc;

  })(Model);

  FormView = (function(superClass) {
    extend(FormView, superClass);

    function FormView(model, elem) {
      var input, j, len1, ref;
      this.elem = elem;
      FormView.__super__.constructor.apply(this, arguments);
      ref = HTMLElement.prototype.querySelectorAll.call(this.elem, '[name]');
      for (j = 0, len1 = ref.length; j < len1; j++) {
        input = ref[j];
        this._setValue(input);
      }
      HTMLElement.prototype.addEventListener.call(this.elem, 'change', (function(_this) {
        return function(e) {
          return _this._setValue(e.target);
        };
      })(this), false);
    }

    FormView.prototype._setValue = function(input) {
      var name, ref, value;
      name = input.name, value = input.value;
      if (!name) {
        return;
      }
      switch ((ref = input.getAttribute('type')) != null ? ref.toLowerCase() : void 0) {
        case 'number':
        case 'range':
          return this.model.set(name, +value || 0);
        case 'date':
        case 'datetime-local':
          return this.model.set(name, new Date(value));
        case 'checkbox':
          return this.model.set(name, input.checked);
        case 'radio':
          if (input.checked) {
            return this.model.set(name, value);
          }
          break;
        default:
          return this.model.set(name, value);
      }
    };

    FormView.prototype.render = function() {
      var input, inputs, j, l, len1, len2, name, ref, value;
      ref = this.model.keys();
      for (j = 0, len1 = ref.length; j < len1; j++) {
        name = ref[j];
        inputs = HTMLFormElement.prototype.querySelectorAll.call(this.elem, "[name=" + name + "]");
        if (!inputs.length) {
          continue;
        }
        value = this.model.get(name);
        switch (inputs[0].type) {
          case 'checkbox':
            inputs[0].checked = value;
            break;
          case 'radio':
            value = value.toString();
            for (l = 0, len2 = inputs.length; l < len2; l++) {
              input = inputs[l];
              if (!(input.value === value)) {
                continue;
              }
              input.checked = true;
              break;
            }
            break;
          default:
            inputs[0].value = value;
        }
      }
    };

    return FormView;

  })(View);

  constants = {
    mosaic: {
      vshader: "attribute vec2 a_position;\nvarying vec2 v_texCoord;\n\nvoid main(){\n  v_texCoord = a_position / 2.0 + vec2(0.5);\n  gl_Position = vec4(a_position, 0.0, 1.0);\n}",
      fshader: {
        noop: "precision mediump float;\nuniform sampler2D u_source;\nvarying vec2 v_texCoord;\n\nvoid main(){\n  gl_FragColor = texture2D(u_source, v_texCoord);\n}",
        reduceColorDithered: "precision mediump float;\nuniform sampler2D u_source;\nuniform sampler2D u_colors;\n\nuniform bool u_vivid;\nuniform float u_brightness;\nuniform float u_contrast;\n\nvarying vec2 v_texCoord;\n      \nconst int COMBINATIONS = 128;\nconst float GAMMA = 2.2;\n\nvec4 gamma(vec4 color){\n  return pow(color, vec4(GAMMA));\n}\nvec4 ungamma(vec4 color){\n  return pow(color, vec4(1.0 / GAMMA));\n}\n\nvoid getColors(in int idx, out vec4 c1, out vec4 c2){\n  float x = (0.5 + float(idx)) / float(COMBINATIONS);\n  c1 = gamma(texture2D(u_colors, vec2(x, 0.0)));\n  c2 = gamma(texture2D(u_colors, vec2(x, 2.0)));\n}\nfloat dist(vec4 srcColor, vec4 color){\n  float d = distance(srcColor, color);\n  if(u_vivid) d /= (distance(vec3(0.5), color.rgb) + 0.4);\n  return d;\n}\nfloat ditherIndex(){\n  float p = floor(mod(gl_FragCoord.x, 4.0));\n  float q = floor(mod(p - gl_FragCoord.y, 4.0));\n  return (\n    8.0 * mod(q, 2.0) +\n    4.0 * mod(p, 2.0) +\n    2.0 * floor(q / 2.0) +\n    floor(p / 2.0) +\n    0.5\n  ) / 16.0;\n}\nfloat calculateBestRatio(vec4 srcColor, vec4 c1, vec4 c2){\n  vec4 dif = c2 - c1;\n  return floor(\n    0.5 + dot(dif, srcColor - c1) / dot(dif, dif) * 16.0\n  ) / 16.0;\n}\nvec4 dither(vec4 srcColor){\n  vec4 c1, c2, canditate;\n  float ratio;\n  float d, minDist = 9.9;\n  float index = ditherIndex();\n  \n  for(int i = 0; i < COMBINATIONS; i++){\n    getColors(i, c1, c2);\n    ratio = calculateBestRatio(srcColor, c1, c2);\n    d =\n      dist(srcColor, mix(c1, c2, clamp(ratio, 0.0, 1.0))) +\n      distance(c1, c2) * 0.2;\n    if(minDist > d){\n      minDist = d;\n      if(index > ratio){\n        canditate = c1;\n      } else {\n        canditate = c2;\n      }\n    }\n  }\n  return canditate;\n}\n  \nfloat filterComponent(float color){\n  color = pow(color, exp(-u_brightness));\n  if(color < 0.5){\n    return 0.5 * pow(2.0 * color, exp(u_contrast));\n  } else {\n    return 0.5 * pow(2.0 * color - 1.0, exp(-u_contrast)) + 0.5;\n  }\n}\nvec4 getSourceColor(){\n  vec4 col = texture2D(u_source, v_texCoord);\n  return gamma(vec4(\n    filterComponent(col.r), filterComponent(col.g),\n    filterComponent(col.b), 1.0\n  ));\n}\nvoid main(){\n  gl_FragColor = ungamma(dither(getSourceColor()));\n}",
        reduceColor: "precision mediump float;\nuniform sampler2D u_source;\nuniform sampler2D u_colors;\n\nuniform bool u_vivid;\nuniform float u_brightness;\nuniform float u_contrast;\n\nvarying vec2 v_texCoord;\n\nconst int COLORLEN = 32;\nconst float GAMMA = 2.2;\n\nvec4 gamma(vec4 color){\n  return pow(color, vec4(GAMMA));\n}\nvec4 ungamma(vec4 color){\n  return pow(color, vec4(1.0 / GAMMA));\n}\n\nvec4 getColor(int idx){\n  float x = (0.5 + float(idx)) / float(COLORLEN);\n  return gamma(texture2D(u_colors, vec2(x, 0.5)));\n}\nfloat dist(vec4 srcColor, vec4 color){\n  float d = distance(srcColor, color);\n  if(u_vivid) d /= (distance(vec3(0.5), color.rgb) + 0.4);\n  return d;\n}\nvec4 nearest(vec4 srcColor){\n  vec4 col, minCol;\n  float d, mind = 9.9;\n  \n  for(int i = 0; i < COLORLEN; i++){\n    col = getColor(i);\n    d = dist(srcColor, col);\n    if(mind > d){\n      minCol = col;\n      mind = d;\n    }\n  }\n  return minCol;\n}\n  \nfloat filterComponent(float color){\n  color = pow(color, exp(-u_brightness));\n  if(color < 0.5){\n    return 0.5 * pow(2.0 * color, exp(u_contrast));\n  } else {\n    return 0.5 * pow(2.0 * color - 1.0, exp(-u_contrast)) + 0.5;\n  }\n}\nvec4 getSourceColor(){\n  vec4 col = texture2D(u_source, v_texCoord);\n  return gamma(vec4(\n    filterComponent(col.r), filterComponent(col.g),\n    filterComponent(col.b), 1.0\n  ));\n}\nvoid main(){\n  gl_FragColor = ungamma(nearest(getSourceColor()));\n}",
        blueprint: "precision mediump float;\nuniform sampler2D u_source;\nuniform vec2 u_unitSize;\nuniform vec2 u_domainSize;\nuniform float u_scale;\nuniform sampler2D u_colors;\n\nvarying vec2 v_texCoord;\n\nconst int COLORLEN = 32;\n\nbool checked(vec4 color){\n  float x;\n  for(int i = 0; i < COLORLEN; i++){\n    x = (0.5 + float(i)) / float(COLORLEN);\n    if(color == texture2D(u_colors, vec2(x, 0.5))) return true;\n  }\n  return false;\n}\nfloat luma(vec4 color){\n  return dot(vec3(0.3, 0.59, 0.11), color.rgb);\n}\nvec4 borderColor(vec4 color, float degree){\n  if(luma(color) < 0.5) return color + vec4(degree);\n  return color - vec4(vec3(degree), 0.0);\n}\nvoid main(){\n  vec2 pos = (gl_FragCoord.xy - vec2(0.5)) / u_scale;\n  vec2 unitCoord = mod(pos, u_unitSize);\n  vec2 domainCoord = mod(pos, u_unitSize * u_domainSize);\n  vec4 color = texture2D(u_source, v_texCoord);\n  \n  if(any(equal(domainCoord, vec2(0.0)))){\n    gl_FragColor = borderColor(color, 1.0);\n  } else if(unitCoord.x == unitCoord.y && checked(color) ||\n      any(equal(unitCoord, vec2(0.0)))){\n    gl_FragColor = borderColor(color, 0.3);\n  } else {\n    gl_FragColor = color;\n  }\n}"
      },
      colors: (function() {
        var b, checked, cls, g, id, j, len1, name, r, ref, results, use;
        cls = [[11, 'Black', 33, 33, 33, true], [10, 'Dark Gray', 107, 90, 90, true], [9, 'Light Gray', 156, 156, 156, true], [49, 'Very Light Gray', 232, 232, 232, true, true], [1, 'White', 255, 255, 255, true], [85, 'Dark Bluish Gray', 89, 93, 96], [86, 'Light Bluish Gray', 175, 181, 199], [7, 'Blue', 0, 87, 166], [5, 'Red', 179, 0, 6], [3, 'Yellow', 247, 209, 23], [6, 'Green', 0, 100, 46], [2, 'Tan', 222, 198, 156], [88, 'Reddish Brown', 137, 53, 29], [63, 'Dark Blue', 20, 48, 68], [104, 'Bright Pink', 243, 154, 194], [8, 'Brown', 83, 33, 21], [89, 'Dark Purple', 95, 38, 131], [59, 'Dark Red', 106, 14, 21], [69, 'Dark Tan', 144, 116, 80], [39, 'Dark Turquoise', 0, 138, 128], [34, 'Lime', 166, 202, 85], [72, 'Maersk Blue', 107, 173, 214], [42, 'Medium Blue', 97, 175, 255], [157, 'Medium Lavender', 181, 165, 213], [31, 'Medium Orange', 255, 165, 49], [4, 'Orange', 255, 126, 20], [23, 'Pink', 255, 199, 225], [24, 'Purple', 165, 73, 156], [55, 'Sand Blue', 90, 113, 132], [48, 'Sand Green', 118, 162, 144]];
        results = [];
        for (j = 0, len1 = cls.length; j < len1; j++) {
          ref = cls[j], id = ref[0], name = ref[1], r = ref[2], g = ref[3], b = ref[4], use = ref[5], checked = ref[6];
          results.push({
            id: id,
            name: name,
            color: new Color(r, g, b),
            use: use,
            checked: checked
          });
        }
        return results;
      })(),
      option: {
        width: 48,
        height: 120,
        mode: 'stack-plate',
        unitSize: [5, 2],
        domainSize: [4, 6],
        dither: false,
        vivid: false,
        brightness: 0,
        contrast: 0,
        scale: 4
      }
    },
    optimizer: {
      dataurl: '/data/',
      appurl: '/optimizer/app'
    }
  };

  Retention = (function() {
    var ELSE, IF, NOT, UNLESS, WHEN;

    Retention.IF = IF = function(ret) {
      return function(success, fail) {
        if (ret.resolved) {
          if (typeof success === "function") {
            success();
          }
        } else if (ret.rejected) {
          if (typeof fail === "function") {
            fail();
          }
        } else {
          success && ret.successCallbacks.push(success);
          fail && ret.failCallbacks.push(fail);
        }
        return ret;
      };
    };

    Retention.UNLESS = UNLESS = function(ret) {
      return function(fail, success) {
        return IF(ret)(success, fail);
      };
    };

    Retention.ELSE = ELSE = function(x) {
      return x;
    };

    Retention.NOT = NOT = function(ret) {
      var r;
      r = new Retention();
      IF(ret)(function() {
        return r.reject(ret.result);
      });
      UNLESS(ret)(function() {
        return r.resolve(ret.error);
      });
      return r;
    };

    Retention.WHEN = WHEN = function(ret) {
      return function(callback) {
        return IF(ret)(callback, callback);
      };
    };

    Retention.prototype.result = null;

    Retention.prototype.error = null;

    Retention.prototype.resolved = false;

    Retention.prototype.rejected = false;

    function Retention() {
      this.successCallbacks = [];
      this.failCallbacks = [];
    }

    Retention.prototype.resolve = function(result) {
      var f, j, len1, ref;
      if (this.resolved || this.rejected) {
        return;
      }
      this.resolved = true;
      this.result = result;
      ref = this.successCallbacks;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        f = ref[j];
        f();
      }
    };

    Retention.prototype.reject = function(error) {
      var f, j, len1, ref;
      if (this.resolved || this.rejected) {
        return;
      }
      this.rejected = true;
      this.error = error;
      ref = this.failCallbacks;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        f = ref[j];
        f();
      }
    };

    Retention.prototype.AND = function(ret) {
      var r;
      r = new Retention();
      IF(this)((function(_this) {
        return function() {
          return IF(ret)(function() {
            return r.resolve();
          });
        };
      })(this));
      IF(ret)((function(_this) {
        return function() {
          return IF(_this)(function() {
            return r.resolve();
          });
        };
      })(this));
      UNLESS(this)(function() {
        return r.reject();
      });
      UNLESS(ret)(function() {
        return r.reject();
      });
      return r;
    };

    Retention.prototype.DAND = function(ret) {
      var r;
      r = new Retention();
      IF(this)((function(_this) {
        return function() {
          return IF(ret)(function() {
            return r.resolve();
          });
        };
      })(this));
      IF(ret)((function(_this) {
        return function() {
          return IF(_this)(function() {
            return r.resolve();
          });
        };
      })(this));
      UNLESS(this)((function(_this) {
        return function() {
          return WHEN(ret)(function() {
            return r.reject();
          });
        };
      })(this));
      UNLESS(ret)((function(_this) {
        return function() {
          return WHEN(_this)(function() {
            return r.reject();
          });
        };
      })(this));
      return r;
    };

    Retention.prototype.OR = function(ret) {
      var r;
      r = new Retention();
      IF(this)(function() {
        return r.resolve();
      });
      IF(ret)(function() {
        return r.resolve();
      });
      UNLESS(this)((function(_this) {
        return function() {
          return UNLESS(ret)(function() {
            return r.reject();
          });
        };
      })(this));
      UNLESS(ret)((function(_this) {
        return function() {
          return UNLESS(_this)(function() {
            return r.reject();
          });
        };
      })(this));
      return r;
    };

    Retention.prototype.DOR = function(ret) {
      var r;
      r = new Retention();
      IF(this)((function(_this) {
        return function() {
          return WHEN(ret)(function() {
            return r.resolve();
          });
        };
      })(this));
      IF(ret)((function(_this) {
        return function() {
          return WHEN(_this)(function() {
            return r.resolve();
          });
        };
      })(this));
      UNLESS(this)((function(_this) {
        return function() {
          return UNLESS(ret)(function() {
            return r.reject();
          });
        };
      })(this));
      UNLESS(ret)((function(_this) {
        return function() {
          return UNLESS(_this)(function() {
            return r.reject();
          });
        };
      })(this));
      return r;
    };

    return Retention;

  })();

  IF = Retention.IF, ELSE = Retention.ELSE;

  xhrget = function(url, param) {
    var k, r, xhr;
    if (param) {
      url += '?' + ((function() {
        var j, len1, ref, results;
        ref = Object.keys(param);
        results = [];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          k = ref[j];
          results.push(k + "=" + param[k]);
        }
        return results;
      })()).join('&');
    }
    r = new Retention();
    xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onload = function() {
      if (xhr.status === 200) {
        return r.resolve(xhr.responseText);
      } else {
        return r.reject(xhr.statusText);
      }
    };
    xhr.onerror = function() {
      return r.reject();
    };
    xhr.send();
    return r;
  };

  DataLoader = (function() {
    function DataLoader() {}

    DataLoader.prototype.load = function(callback, errorCallback) {
      var baseurl, categories, codesData, colorNames, colors, colorsData, parts, partsData;
      colors = {};
      colorNames = {};
      parts = {};
      categories = {};
      baseurl = constants.optimizer.dataurl;
      colorsData = this.get(baseurl + 'colors');
      codesData = this.get(baseurl + 'codes');
      partsData = this.get(baseurl + 'parts');
      return IF(colorsData.AND(codesData.AND(partsData)))(function() {
        var category, categoryId, categoryName, color, colorId, colorName, id, j, l, len1, len2, len3, m, name, part, ref, ref1, ref2, ref3, ref4, ref5, rrggbb;
        ref = colorsData.result;
        for (j = 0, len1 = ref.length; j < len1; j++) {
          ref1 = ref[j], colorId = ref1[0], colorName = ref1[1], rrggbb = ref1[2];
          colors[colorId] = colorNames[colorName] = {
            id: colorId,
            name: unescapeHTML(colorName),
            rgb: '#' + rrggbb
          };
        }
        ref2 = codesData.result;
        for (l = 0, len2 = ref2.length; l < len2; l++) {
          ref3 = ref2[l], id = ref3[0], colorName = ref3[1];
          color = colorNames[colorName];
          if (!color) {
            continue;
          }
          part = parts[id] || (parts[id] = {
            id: id,
            colors: []
          });
          if (indexOf.call(part.colors, color) < 0) {
            part.colors.push(color);
          }
        }
        ref4 = partsData.result;
        for (m = 0, len3 = ref4.length; m < len3; m++) {
          ref5 = ref4[m], categoryId = ref5[0], categoryName = ref5[1], id = ref5[2], name = ref5[3];
          part = parts[id];
          if (!part) {
            continue;
          }
          category = categories[categoryId] || (categories[categoryId] = {
            id: categoryId,
            name: unescapeHTML(categoryName),
            parts: []
          });
          part.name = unescapeHTML(name);
          part.categoryId = categoryId;
          category.parts.push(part);
        }
        return callback({
          categories: categories,
          parts: parts,
          colors: colors
        });
      }, ELSE(function() {
        return typeof errorCallback === "function" ? errorCallback() : void 0;
      }));
    };

    DataLoader.prototype.get = function(url) {
      var data, r;
      r = new Retention();
      data = xhrget(url);
      IF(data)(function() {
        var line;
        return r.resolve((function() {
          var j, len1, ref, results;
          ref = data.result.trim().split('\r\n');
          results = [];
          for (j = 0, len1 = ref.length; j < len1; j++) {
            line = ref[j];
            results.push(line.split('\t'));
          }
          return results;
        })());
      }, ELSE(function() {
        return r.reject();
      }));
      return r;
    };

    return DataLoader;

  })();

  StoreDataLoader = (function() {
    function StoreDataLoader() {}

    StoreDataLoader.prototype.load = function(callback, errorCallback, params) {
      var baseurl, data, param;
      baseurl = constants.optimizer.appurl + '/getstoredata';
      data = (function() {
        var j, len1, results;
        results = [];
        for (j = 0, len1 = params.length; j < len1; j++) {
          param = params[j];
          results.push(xhrget(baseurl, param));
        }
        return results;
      })();
      return IF(data.reduce(function(pre, cur) {
        return pre.AND(cur);
      }))(function() {
        var d, result;
        result = (function() {
          var j, len1, results;
          results = [];
          for (j = 0, len1 = data.length; j < len1; j++) {
            d = data[j];
            results.push(JSON.parse(d.result));
          }
          return results;
        })();
        return callback(result);
      }, ELSE(function() {
        return errorCallback();
      }));
    };

    return StoreDataLoader;

  })();

  Solver = (function() {

    /*
      items = [item]
      item = { id, part, color, amount, stores }
      stores = [store]
      store = { id, name, items }
      matrix = (item, store) -> { price }
     */
    var calcStores, jointAsSet, totalPrice;

    function Solver() {}

    jointAsSet = function(a1, a2) {
      var item, j, len1, res;
      res = [].concat(a1);
      for (j = 0, len1 = a2.length; j < len1; j++) {
        item = a2[j];
        if (indexOf.call(a1, item) < 0) {
          res.push(item);
        }
      }
      return res;
    };

    calcStores = function(items, stores, storeNum) {
      var comb, idx, j, l, len1, len2, ref, restItems, restStores, result, store, threshold;
      if (items.length === 0) {
        return [[]];
      }
      if (storeNum === 0) {
        return [];
      }
      result = [];
      threshold = items.length / storeNum;
      for (idx = j = 0, len1 = stores.length; j < len1; idx = ++j) {
        store = stores[idx];
        if (store.items.length < threshold) {
          return result;
        }
        restItems = items.filter(function(item) {
          return indexOf.call(store.items, item) < 0;
        });
        restStores = stores.slice(idx);
        ref = calcStores(restItems, restStores, storeNum - 1);
        for (l = 0, len2 = ref.length; l < len2; l++) {
          comb = ref[l];
          result.push([store].concat(comb));
        }
      }
      return result;
    };

    totalPrice = function(items, stores, matrix) {
      var i, item, j, len1, res, store;
      res = 0;
      for (i = j = 0, len1 = items.length; j < len1; i = ++j) {
        item = items[i];
        store = stores[i];
        res += matrix.get(item, store).price * item.amount;
      }
      return res;
    };

    Solver.prototype.solve = function(items, stores, matrix) {
      var buyableItems, item, j, largest, len1, minStoreNum, solutions, storeList, storeLists;
      for (j = 0, len1 = items.length; j < len1; j++) {
        item = items[j];
        if (item.stores.length === 0) {
          return [];
        }
      }
      stores = new SuperArray(stores.sort(function(a, b) {
        return b.items.length - a.items.length;
      }));
      buyableItems = stores[0].items;
      minStoreNum = 1;
      while (buyableItems.length < items.length) {
        largest = stores.maxBy(function(store) {
          return store.items.filter(function(item) {
            return indexOf.call(buyableItems, item) < 0;
          }).length;
        });
        buyableItems = jointAsSet(buyableItems, largest.items);
        minStoreNum++;
      }
      storeLists = calcStores(items, stores, minStoreNum);
      solutions = (function() {
        var l, len2, results;
        results = [];
        for (l = 0, len2 = storeLists.length; l < len2; l++) {
          storeList = storeLists[l];
          results.push((function() {
            var len3, m, results1;
            results1 = [];
            for (m = 0, len3 = items.length; m < len3; m++) {
              item = items[m];
              results1.push(new SuperArray(storeList).minBy(function(store) {
                var ref;
                return ((ref = matrix.get(item, store)) != null ? ref.price : void 0) || 2e308;
              }));
            }
            return results1;
          })());
        }
        return results;
      })();
      return solutions.sort(function(a, b) {
        return totalPrice(items, a, matrix) - totalPrice(items, b, matrix);
      });
    };

    return Solver;

  })();

  ItemStoreMatrix = (function() {
    function ItemStoreMatrix() {
      this.map = {};
    }

    ItemStoreMatrix.prototype.set = function(item, store, value) {
      var base, name1, row;
      row = (base = this.map)[name1 = item.id] || (base[name1] = {});
      return row[store.id] = value;
    };

    ItemStoreMatrix.prototype.get = function(item, store) {
      var ref;
      return (ref = this.map[item.id]) != null ? ref[store.id] : void 0;
    };

    return ItemStoreMatrix;

  })();

  SelectModel = (function(superClass) {
    extend(SelectModel, superClass);

    function SelectModel(type1) {
      this.type = type1;
      SelectModel.__super__.constructor.apply(this, arguments);
      this.item = null;
      this.options = [];
    }

    SelectModel.prototype.reset = function(source) {
      var id, ids, j, len1;
      this.options = [];
      if (Array.isArray(source)) {
        this.options = this.options.concat(source);
      } else {
        ids = Object.keys(source).sort(function(a, b) {
          return source[a].name.localeCompare(source[b].name);
        });
        for (j = 0, len1 = ids.length; j < len1; j++) {
          id = ids[j];
          this.add(source[id], false);
        }
      }
      return this.change();
    };

    SelectModel.prototype.add = function(item, change) {
      if (change == null) {
        change = true;
      }
      this.options.push(item);
      if (change) {
        return this.change('add', item);
      }
    };

    SelectModel.prototype.remove = function() {
      var idx, item;
      item = this.item;
      this.item = null;
      idx = this.options.indexOf(item);
      this.options.splice(idx, 1);
      this.change();
      return item;
    };

    SelectModel.prototype.setItem = function(id) {
      var j, len1, option, ref;
      ref = this.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        option = ref[j];
        if (option.id === id) {
          this.item = option;
          this.change('select', option);
          return;
        }
      }
    };

    return SelectModel;

  })(Model);

  DataProcessor = (function(superClass) {
    extend(DataProcessor, superClass);

    function DataProcessor() {
      DataProcessor.__super__.constructor.apply(this, arguments);
      this.items = [];
      this.stores = [];
      this.matrix = new ItemStoreMatrix();
      this._loader = new StoreDataLoader();
      this._solver = new Solver();
    }

    DataProcessor.prototype.reset = function() {
      this.items = [];
      return this.change('reset');
    };

    DataProcessor.prototype.process = function(items1) {
      var item, params;
      this.items = items1;
      params = (function() {
        var j, len1, ref, results;
        ref = this.items;
        results = [];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          item = ref[j];
          results.push({
            part: item.part.id,
            color: item.color.id,
            amount: item.amount
          });
        }
        return results;
      }).call(this);
      this._loader.load((function(_this) {
        return function(data) {
          _this.makeMatrix(data);
          _this.result = _this._solver.solve(_this.items, _this.stores, _this.matrix);
          return _this.change();
        };
      })(this), (function(_this) {
        return function() {
          return _this.change('error');
        };
      })(this), params);
      return this.change('start');
    };

    DataProcessor.prototype.makeMatrix = function(storeData) {
      var idx, item, j, key, l, len1, len2, name1, s, sData, store, storeMap;
      storeMap = {};
      for (idx = j = 0, len1 = storeData.length; j < len1; idx = ++j) {
        sData = storeData[idx];
        item = this.items[idx];
        item.stores = [];
        for (l = 0, len2 = sData.length; l < len2; l++) {
          s = sData[l];
          store = storeMap[name1 = s.id] || (storeMap[name1] = {
            id: s.id,
            name: s.name,
            items: []
          });
          store.items.push(item);
          item.stores.push(store);
          this.matrix.set(item, store, {
            price: s.price,
            url: s.url
          });
        }
      }
      return this.stores = (function() {
        var len3, m, ref, results;
        ref = Object.keys(storeMap);
        results = [];
        for (m = 0, len3 = ref.length; m < len3; m++) {
          key = ref[m];
          results.push(storeMap[key]);
        }
        return results;
      })();
    };

    return DataProcessor;

  })(Model);

  Router = (function() {
    function Router(select) {
      this.select = select;
      this.select.listen('add', this.update.bind(this));
      this.select.listen('change', this.update.bind(this));
    }

    Router.prototype.update = function() {
      var query;
      query = this.dump(this.select.options);
      return window.history.replaceState(query, null, '?o=' + query);
    };

    Router.prototype.setData = function(data1) {
      var item, items, j, len1, query, ref, search;
      this.data = data1;
      search = decodeURIComponent(location.search);
      query = (ref = /[?&]o=([\w,|]*)/.exec(search)) != null ? ref[1] : void 0;
      items = this.load(query);
      for (j = 0, len1 = items.length; j < len1; j++) {
        item = items[j];
        this.select.add(item, false);
      }
      return this.select.change();
    };

    Router.prototype.dump = function(items) {
      var amount, color, part;
      return ((function() {
        var j, len1, ref, results;
        results = [];
        for (j = 0, len1 = items.length; j < len1; j++) {
          ref = items[j], part = ref.part, color = ref.color, amount = ref.amount;
          results.push(part.id + "," + color.id + "," + amount);
        }
        return results;
      })()).join('|');
    };

    Router.prototype.load = function(str) {
      var amount, color, colorId, id, j, len1, part, ref, ref1, result, s;
      if (!str) {
        return [];
      }
      result = [];
      ref = str.split('|');
      for (j = 0, len1 = ref.length; j < len1; j++) {
        s = ref[j];
        ref1 = s.split(','), id = ref1[0], colorId = ref1[1], amount = ref1[2];
        part = this.data.parts[id];
        color = this.data.colors[colorId];
        if (part && color) {
          amount = amount > 0 ? amount | 0 : 1;
          result.push({
            id: uuid(),
            part: part,
            color: color,
            amount: amount
          });
        }
      }
      return result;
    };

    return Router;

  })();

  Searcher = (function() {
    function Searcher() {
      this.options = [];
      this.data = [];
    }

    Searcher.prototype.setData = function(source) {
      var key;
      return this.data = (function() {
        var j, len1, ref, results;
        ref = Object.keys(source);
        results = [];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          key = ref[j];
          results.push(source[key]);
        }
        return results;
      })();
    };

    Searcher.prototype.tokenize = function(query) {
      return query.toLowerCase().split(/[,\s]+/);
    };

    Searcher.prototype.convertToken = function(token) {
      return token.replace(/([\/\.\d]+)(x)([\/\.\d]*)(x?)([\/\.\d]*)/, function() {
        var arg;
        arg = 1 <= arguments.length ? slice.call(arguments, 0) : [];
        return arg.slice(1, 6).join(' ').trim();
      }).replace(/\+/g, ' ');
    };

    Searcher.prototype.match = function(text, tokens) {
      var j, len1, t;
      if ((!text) || (tokens.length === 0)) {
        return;
      }
      text = text.toLowerCase();
      for (j = 0, len1 = tokens.length; j < len1; j++) {
        t = tokens[j];
        if (text.indexOf(t) === -1) {
          return false;
        }
      }
      return true;
    };

    Searcher.prototype.search = function(query) {
      var item, j, len1, options, ref, t, tokens;
      if (query.trim().length <= 1) {
        return this.options = [];
      }
      tokens = (function() {
        var j, len1, ref, results;
        ref = this.tokenize(query);
        results = [];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          t = ref[j];
          results.push(this.convertToken(t));
        }
        return results;
      }).call(this);
      options = [];
      ref = this.data;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        item = ref[j];
        if (!(this.match(item.name, tokens))) {
          continue;
        }
        options.push(item);
        if (options.length > 100) {
          break;
        }
      }
      return this.options = options;
    };


    /*
    
    search: (query) ->
      if query.length <= 1
        return @options = []
      options = []
      levels = {}
      tokens = (query.toLowerCase().slice(i, i + 2) for i in [0...query.length - 1] by 1)
      for item, i in @data
        text = item.name.toLowerCase()
        level = 0
        unmatch = true
        for t in tokens
          if text.indexOf(t) >= 0
            level++
            unmatch = false
          else if unmatch
            level = 0
            break
          else
            unmatch = true
        if level and (not unmatch)
          levels[item.id] = level / text.length
          bottom = options[100]
          if (not bottom) or (levels[bottom.id] < level / text.length)
            options.unshift(item)
      @options = options.sort (a, b) ->
        levels[b.id] - levels[a.id]
     */

    return Searcher;

  })();

  SelectView = (function(superClass) {
    extend(SelectView, superClass);

    function SelectView(model, elem) {
      this.elem = elem;
      SelectView.__super__.constructor.apply(this, arguments);
      model.listen('add', this.add.bind(this));
    }

    SelectView.prototype._createLi = function(item) {
      var id, li, type;
      type = escapeHTML(this.model.type);
      id = escapeHTML(item.id);
      li = document.createElement('li');
      li.insertAdjacentHTML('beforeend', "<input type=\"radio\" id=\"" + (type + id) + "\" name=\"" + type + "\" value=\"" + id + "\">\n<label for=\"" + (type + id) + "\">" + (escapeHTML(item.name)) + "</label>");
      return li;
    };

    SelectView.prototype.add = function(option) {
      return this.elem.appendChild(this._createLi(option));
    };

    SelectView.prototype.render = function() {
      var frag, j, len1, option, ref;
      this.elem.innerHTML = '';
      frag = document.createDocumentFragment();
      ref = this.model.options;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        option = ref[j];
        frag.appendChild(this._createLi(option));
      }
      return this.elem.appendChild(frag);
    };

    return SelectView;

  })(View);

  ColorSelectView = (function(superClass) {
    extend(ColorSelectView, superClass);

    function ColorSelectView() {
      return ColorSelectView.__super__.constructor.apply(this, arguments);
    }

    ColorSelectView.prototype._createLi = function(item) {
      var id, li;
      id = escapeHTML(item.id);
      li = document.createElement('li');
      li.insertAdjacentHTML('beforeend', "<input type=\"radio\" id=\"color" + id + "\" name=\"color\" value=\"" + id + "\">\n<label for=\"color" + id + "\">\n  <span class=\"color-box\"\n    style=\"background-color: " + (escapeHTML(item.rgb)) + ";\"></span>\n  " + (escapeHTML(item.name)) + "\n</label>");
      return li;
    };

    return ColorSelectView;

  })(SelectView);

  CartSelectView = (function(superClass) {
    extend(CartSelectView, superClass);

    function CartSelectView() {
      return CartSelectView.__super__.constructor.apply(this, arguments);
    }

    CartSelectView.prototype._createLi = function(item) {
      var id, li, text;
      id = escapeHTML(item.id);
      text = escapeHTML("(" + item.amount + "x) " + item.color.name + " " + item.part.name);
      li = document.createElement('li');
      li.insertAdjacentHTML('beforeend', "<input type=\"radio\" id=\"cart" + id + "\" name=\"cart\" value=\"" + id + "\">\n<label for=\"cart" + id + "\">\n  <span class=\"color-box\"\n    style=\"background-color: " + (escapeHTML(item.color.rgb)) + ";\"></span>\n  " + text + "\n</label>");
      return li;
    };

    return CartSelectView;

  })(SelectView);

  PartImageView = (function(superClass) {
    extend(PartImageView, superClass);

    function PartImageView(model, elem) {
      var img;
      this.elem = elem;
      PartImageView.__super__.constructor.apply(this, arguments);
      img = document.createElement('img');
      this.elem.appendChild(img);
      model.listen('select', function(item) {
        var colorId;
        colorId = item.colors[0].id;
        img.onerror = function() {
          this.src = "http://img.bricklink.com/P/" + colorId + "/" + item.id + ".jpg";
          return this.onerror = null;
        };
        return img.src = "http://img.bricklink.com/P/" + colorId + "/" + item.id + ".gif";
      });
    }

    return PartImageView;

  })(View);

  ResultView = (function(superClass) {
    extend(ResultView, superClass);

    function ResultView(model, elem) {
      this.elem = elem;
      ResultView.__super__.constructor.apply(this, arguments);
      model.listen('reset', this.hide.bind(this));
      this.showing = false;
    }

    ResultView.prototype._td = function(text) {
      var td;
      td = document.createElement('td');
      td.appendChild(document.createTextNode(text));
      return td;
    };

    ResultView.prototype._createRow = function(item, store) {
      var price, ref, text, tr, url;
      ref = this.model.matrix.get(item, store), price = ref.price, url = ref.url;
      text = escapeHTML(item.color.name + ' ' + item.part.name);
      tr = document.createElement('tr');
      tr.insertAdjacentHTML('beforeend', "<td>\n  <span class=\"color-box\"\n    style=\"background-color: " + (escapeHTML(item.color.rgb)) + ";\"></span>\n  <a href=\"http://www.bricklink.com/catalogPG.asp?P=" + item.part.id + "&colorID=" + item.color.id + "\" target=\"_blank\">\n    " + text + "\n  </a>\n</td>\n<td>\n  <a href=\"http://www.bricklink.com" + (escapeHTML(url)) + "\" target=\"_blank\">\n    " + (escapeHTML(store.name)) + "\n  </a>\n</td>");
      tr.appendChild(this._td(price));
      tr.appendChild(this._td(item.amount));
      tr.appendChild(this._td((price * item.amount).toFixed(2)));
      return tr;
    };

    ResultView.prototype._createTable = function(solution) {
      var footer, frag, header, i, item, j, len1, store, wholePrice;
      frag = document.createDocumentFragment();
      header = document.createElement('tr');
      header.innerHTML = '<th>部品</th><th>店名</th><th>単価（円）</th><th>個数</th><th>小計</th>';
      frag.appendChild(header);
      wholePrice = 0;
      for (i = j = 0, len1 = solution.length; j < len1; i = ++j) {
        store = solution[i];
        item = this.model.items[i];
        frag.appendChild(this._createRow(item, store));
        wholePrice += this.model.matrix.get(item, store).price * item.amount;
      }
      footer = document.createElement('tr');
      footer.innerHTML = "<td colspan='3'><td>合計</td><td><b>" + (wholePrice.toFixed(2)) + "</b></td>";
      frag.appendChild(footer);
      return frag;
    };

    ResultView.prototype.hide = function() {
      this.elem.className = '';
      return this.showing = false;
    };

    ResultView.prototype.render = function() {
      var j, len1, ref, solution, table, tbody;
      if (!this.model.result.length) {
        return;
      }
      this.elem.innerHTML = '';
      table = document.createElement('table');
      tbody = document.createElement('tbody');
      ref = this.model.result.slice(0, 20);
      for (j = 0, len1 = ref.length; j < len1; j++) {
        solution = ref[j];
        tbody.appendChild(this._createTable(solution));
      }
      table.appendChild(tbody);
      this.elem.appendChild(table);
      this.elem.className = 'displayed';
      return this.showing = true;
    };

    return ResultView;

  })(View);

  ProgressButton = (function(superClass) {
    extend(ProgressButton, superClass);

    function ProgressButton(model, elem) {
      this.elem = elem;
      ProgressButton.__super__.constructor.apply(this, arguments);
      model.listen('start', this.start.bind(this));
      model.listen('error', this.error.bind(this));
      model.listen('reset', this.reset.bind(this));
      this.reset();
    }

    ProgressButton.prototype._setBackground = function(color) {
      return this.elem.style.backgroundColor = color;
    };

    ProgressButton.prototype.error = function() {
      this.elem.disabled = false;
      this.elem.value = 'エラー、あとでやり直してください';
      this.elem.className = 'button error';
      return setTimeout(this.reset.bind(this), 3000);
    };

    ProgressButton.prototype.start = function() {
      this.elem.disabled = true;
      return this.elem.value = 'データを集めています...';
    };

    ProgressButton.prototype.reset = function() {
      this.elem.disabled = false;
      this.elem.value = 'このパーツで店を探す';
      return this.elem.className = 'button';
    };

    ProgressButton.prototype.render = function() {
      this.elem.disabled = false;
      if (this.model.result.length) {
        this.elem.value = 'パーツを選びなおす';
        return this.elem.className = 'button';
      } else {
        this.elem.value = 'パーツを減らしてください';
        this.elem.className = 'button error';
        return setTimeout(this.reset.bind(this), 3000);
      }
    };

    return ProgressButton;

  })(View);

  (function() {
    var addItem, cart, cartSelect, categorySelect, colorSelect, editItem, partSelect, processor, removeItem, router, searcher;
    categorySelect = new SelectModel('category');
    partSelect = new SelectModel('part');
    colorSelect = new SelectModel('color');
    cartSelect = new SelectModel('cart');
    cart = new Assoc();
    processor = new DataProcessor();
    searcher = new Searcher();
    router = new Router(cartSelect);
    cart.listen(function(type, id) {
      switch (type) {
        case 'category':
          categorySelect.setItem(id);
          partSelect.reset(categorySelect.item.parts);
          return colorSelect.reset([]);
        case 'part':
          partSelect.setItem(id);
          return colorSelect.reset(partSelect.item.colors);
        case 'color':
          return colorSelect.setItem(id);
        case 'cart':
          return cartSelect.setItem(id);
      }
    });
    addItem = function() {
      var amount, color, part;
      part = partSelect.item;
      color = colorSelect.item;
      amount = cart.get('amount');
      if (part && color && amount) {
        return cartSelect.add({
          id: uuid(),
          part: part,
          color: color,
          amount: amount
        });
      }
    };
    removeItem = function() {
      return cartSelect.remove();
    };
    editItem = function() {
      var amount, color, item, part;
      item = removeItem();
      if (!item) {
        return;
      }
      part = item.part, color = item.color, amount = item.amount;
      cart.set('category', part.categoryId);
      cart.set('part', part.id);
      cart.set('color', color.id);
      return cart.set('amount', amount);
    };
    document.addEventListener('DOMContentLoaded', function() {
      var resultView;
      new SelectView(categorySelect, $('categorySelect'));
      new SelectView(partSelect, $('partSelect'));
      new PartImageView(partSelect, $('image'));
      new ColorSelectView(colorSelect, $('colorSelect'));
      new CartSelectView(cartSelect, $('cart'));
      new FormView(cart, $('form'));
      resultView = new ResultView(processor, $('result'));
      new ProgressButton(processor, $('calculateButton'));
      $('addButton').addEventListener('click', addItem, false);
      $('editButton').addEventListener('click', editItem, false);
      $('removeButton').addEventListener('click', removeItem, false);
      $('calculateButton').addEventListener('click', function() {
        if (resultView.showing) {
          return processor.reset();
        } else {
          return processor.process(cartSelect.options);
        }
      }, false);
      return $('searchBox').addEventListener('input', function() {
        return partSelect.reset(searcher.search(this.value));
      }, false);
    }, false);
    return new DataLoader().load(function(data) {
      categorySelect.reset(data.categories);
      searcher.setData(data.parts);
      return router.setData(data);
    });
  })();

}).call(this);
